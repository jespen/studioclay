---
deployment:
  tasks:
    - export DEPLOYPATH=/home/gyckh2yxxvf4/public_html
    - export BACKUPPATH=/home/gyckh2yxxvf4/site_backups
    
    # Log the current directory for debugging
    - pwd > $DEPLOYPATH/deploy_start_dir.txt
    
    # Create backup directory if it doesn't exist
    - /bin/mkdir -p $BACKUPPATH
    
    # Backup current public_html before making changes
    - /bin/mkdir -p $BACKUPPATH/backup_$(date +%Y%m%d_%H%M%S)
    - /bin/cp -R $DEPLOYPATH/* $BACKUPPATH/backup_$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
    
    # Build directly in the repository directory
    - npm install
    - npm run export
    
    # Check if the out directory was created
    - /bin/ls -la out > $DEPLOYPATH/build_output_listing.txt
    
    # Clean the destination directory (preserve the logs and htaccess)
    - /bin/find $DEPLOYPATH -mindepth 1 -not -name "*.txt" -not -name ".htaccess" -delete
    
    # Copy the built files directly to the public_html directory
    - /bin/cp -R out/. $DEPLOYPATH/
    
    # Create a default index.php that points to index.html for backward compatibility
    - echo '<?php header("Location: index.html"); ?>' > $DEPLOYPATH/index.php
    
    # Set correct file permissions
    - /bin/chmod 644 $DEPLOYPATH/*.html
    - /bin/chmod 644 $DEPLOYPATH/*.js
    - /bin/chmod 644 $DEPLOYPATH/*.css
    - /bin/chmod 644 $DEPLOYPATH/*.txt
    - /bin/chmod 644 $DEPLOYPATH/*.php
    
    # Make directories readable and executable
    - /bin/find $DEPLOYPATH -type d -exec chmod 755 {} \;
    
    # Copy any backup files to the backup directory
    - /bin/mkdir -p backups
    - /bin/cp -R backups/*.zip $BACKUPPATH/ 2>/dev/null || true
    
    # Keep only the 10 most recent backups in the backup directory
    - cd $BACKUPPATH && ls -t | tail -n +11 | xargs rm -rf 2>/dev/null || true
    
    # List directory after deployment to verify
    - /bin/ls -la $DEPLOYPATH > $DEPLOYPATH/post_deploy_listing.txt
    - echo "Deployment completed successfully at $(date)" > $DEPLOYPATH/deploy_info.txt